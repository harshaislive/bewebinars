<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipedrive Actions - Webinar Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; }
        .table th { font-size: 0.85rem; text-transform: uppercase; color: #6c757d; }
        .status-badge { font-size: 0.8rem; }
        .loading-spinner { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Pipedrive Actions</h2>
        <div>
            <span id="authStatus" class="badge bg-secondary me-2">Checking Login...</span>
            <a href="/" class="btn btn-outline-primary btn-sm">Back to Dashboard</a>
        </div>
    </div>

    <!-- Alert Area -->
    <div id="alertArea"></div>

    <!-- Step 1: Select Webinar -->
    <div class="card">
        <div class="card-header">1. Select a Past Webinar</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <select id="webinarSelect" class="form-select">
                        <option value="" selected disabled>Loading past webinars...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button id="loadAttendeesBtn" class="btn btn-primary w-100" disabled>
                        List Attendees
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Manage Attendees -->
    <div class="card" id="attendeesCard" style="display:none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>2. Manage Attendees (<span id="attendeeCount">0</span>)</span>
            <button id="refreshPipedriveBtn" class="btn btn-sm btn-outline-secondary">
                Re-check All Pipedrive
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Attendee</th>
                            <th>Email</th>
                            <th>Attended?</th>
                            <th>Pipedrive Deal</th>
                            <th>Current Owner</th>
                            <th style="width: 250px;">Change Owner</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="attendeesTableBody">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allSessions = [];
    let pdUsers = [];

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        const isLoggedIn = await checkAuth();
        if (isLoggedIn) {
            await Promise.all([fetchPastWebinars(), fetchPipedriveUsers()]);
        }
    });

    async function checkAuth() {
        try {
            const res = await fetch('/api/auth-status');
            const data = await res.json();
            const badge = document.getElementById('authStatus');
            if (data.isLoggedIn) {
                badge.className = 'badge bg-success me-2';
                badge.textContent = 'Admin Logged In';
                return true;
            } else {
                badge.className = 'badge bg-danger me-2';
                badge.textContent = 'Not Logged In';
                window.location.href = '/login.html';
                return false;
            }
        } catch (e) {
            console.error(e);
            return false;
        }
    }

    // --- Data Fetching ---
    async function fetchPastWebinars() {
        try {
            const res = await fetch('/api/webinars/past');
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);

            const select = document.getElementById('webinarSelect');
            select.innerHTML = '<option value="" selected disabled>Select a webinar...</option>';
            
            allSessions = [];
            
            // Flatten sessions
            data.collectives.forEach(c => {
                c.sessions.forEach(s => {
                    // Add collective name to session for display
                    s.collectiveName = c.collective;
                    allSessions.push(s);
                });
            });

            // Sort by date desc
            allSessions.sort((a, b) => new Date(b.isoDate) - new Date(a.isoDate));

            allSessions.forEach((s, index) => {
                const opt = document.createElement('option');
                opt.value = index; // using index as ID for simplicity
                opt.textContent = `${s.dateString} - ${s.collectiveName} (${s.eventName}) - ${s.attendees.length} Registrants`;
                select.appendChild(opt);
            });

            select.addEventListener('change', () => {
                document.getElementById('loadAttendeesBtn').disabled = false;
            });

        } catch (err) {
            showAlert('danger', 'Failed to load webinars: ' + err.message);
        }
    }

    async function fetchPipedriveUsers() {
        try {
            const res = await fetch('/api/pipedrive/users');
            const data = await res.json();
            if (data.success) {
                pdUsers = data.data;
            } else {
                console.error('Failed to fetch PD users:', data.message);
            }
        } catch (err) {
            console.error('Error fetching PD users:', err);
        }
    }

    // --- UI Logic ---
    document.getElementById('loadAttendeesBtn').addEventListener('click', () => {
        const index = document.getElementById('webinarSelect').value;
        if (index === '') return;

        const session = allSessions[index];
        renderAttendees(session);
    });

    document.getElementById('refreshPipedriveBtn').addEventListener('click', async () => {
        // Trigger re-check for all visible rows
        const rows = document.querySelectorAll('#attendeesTableBody tr');
        rows.forEach(row => {
            const email = row.dataset.email;
            if (email) checkPipedriveForEmail(email, row);
        });
    });

    function renderAttendees(session) {
        const tbody = document.getElementById('attendeesTableBody');
        tbody.innerHTML = '';
        
        // Use registrants (attendees array) as base
        // Mark if they are in attendanceList
        const attendanceEmails = new Set(session.attendanceList.map(a => (a.email || '').toLowerCase()));

        session.attendees.forEach(p => {
            const tr = document.createElement('tr');
            tr.dataset.email = p.email;
            
            const attended = attendanceEmails.has((p.email || '').toLowerCase());
            
            tr.innerHTML = `
                <td>${p.name || 'Unknown'}</td>
                <td>${p.email || 'No Email'}</td>
                <td>${attended ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-light text-dark">No</span>'}</td>
                <td class="pd-status"><span class="spinner-border spinner-border-sm text-secondary"></span> Checking...</td>
                <td class="pd-owner">-</td>
                <td>
                    <select class="form-select form-select-sm owner-select" disabled>
                        <option value="">Loading Users...</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary update-btn" disabled>Update</button>
                </td>
            `;
            tbody.appendChild(tr);

            // Trigger PD Check
            if (p.email) {
                checkPipedriveForEmail(p.email, tr);
            } else {
                tr.querySelector('.pd-status').innerHTML = '<span class="text-muted">No Email</span>';
            }
        });

        document.getElementById('attendeeCount').textContent = session.attendees.length;
        document.getElementById('attendeesCard').style.display = 'block';
    }

    async function checkPipedriveForEmail(email, row) {
        try {
            const res = await fetch('/api/pipedrive/find-deal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await res.json();

            const statusCell = row.querySelector('.pd-status');
            const ownerCell = row.querySelector('.pd-owner');
            const select = row.querySelector('.owner-select');
            const btn = row.querySelector('.update-btn');

            if (data.success && data.deal) {
                statusCell.innerHTML = `<a href="https://${data.company_domain}.pipedrive.com/deal/${data.deal.id}" target="_blank" class="text-decoration-none">Deal #${data.deal.id}</a>`;
                ownerCell.textContent = data.deal.owner_name;
                row.dataset.dealId = data.deal.id; // Store deal ID
                
                // Populate Select
                populateOwnerSelect(select, data.deal.user_id.id || data.deal.user_id); // API might return object or ID
                select.disabled = false;
                btn.disabled = false;

                // Bind Update Action
                btn.onclick = () => updateOwner(data.deal.id, select.value, row);

            } else {
                statusCell.innerHTML = '<span class="text-warning">Not Found</span>';
                ownerCell.textContent = '-';
                select.innerHTML = '<option disabled>No Deal</option>';
            }
        } catch (err) {
            row.querySelector('.pd-status').innerHTML = '<span class="text-danger">Error</span>';
        }
    }

    function populateOwnerSelect(select, currentOwnerId) {
        select.innerHTML = '';
        pdUsers.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = u.name;
            if (u.id == currentOwnerId) opt.selected = true;
            select.appendChild(opt);
        });
    }

    async function updateOwner(dealId, newOwnerId, row) {
        const btn = row.querySelector('.update-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '...';

        try {
            const res = await fetch('/api/pipedrive/update-deal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dealId, newOwnerId })
            });
            const data = await res.json();

            if (data.success) {
                btn.textContent = 'Saved';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');
                
                // Update "Current Owner" cell text
                const select = row.querySelector('.owner-select');
                const selectedText = select.options[select.selectedIndex].text;
                row.querySelector('.pd-owner').textContent = selectedText;

                setTimeout(() => {
                    btn.textContent = 'Update';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                    btn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.message);
            }
        } catch (err) {
            alert('Failed to update: ' + err.message);
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function showAlert(type, message) {
        const area = document.getElementById('alertArea');
        area.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
    }
</script>
</body>
</html>
